# Firewall Rule Operator
The Firewall Rule Operator can create and delete Firewall Rules in an external (to the kubernetes cluster) Firewall, currently pfSense.

## Design
The Operator is written in Ansible using the [operator-sdk](https://github.com/operator-framework/operator-sdk/blob/master/doc/ansible/user-guide.md) and leverages the [pfsensible](https://github.com/pfsensible/core) Ansible modules from Ansible Galaxy.

Most of the checked in code was autogenerated using the following command:
```shell
operator-sdk new firewallrule --type ansible --kind FirewallRule --api-version manuela.redhat.com/v1alpha1 --generate-playbook
```

## Development
In the autogenerated code, the following files are of importance and have been modified or added:

* [build/Dockerfile](build/Dockerfile): modified to include SSH client and pfsensible modules in the operator image
* [deploy/crds/manuela.redhat.com_v1alpha1_firewallrule_cr.yaml](deploy/crds/manuela.redhat.com_v1alpha1_firewallrule_cr.yaml): modified as an example firewall rule
* [deploy/kustomization.yaml](deploy/kustomization.yaml): added to allow a single command (kubectl apply -k deploy) installation of the operator supporting artefacts (CRD, role, SA, ...) without the actual operator deployment and its secret 
* [deploy/firewall-inventory-secret-example.yaml](deploy/firewall-inventory-secret-example.yaml): added as a sample secret that provides the firewall access data. This cannot be instantiated as is but needs adaptation with the true endpoint, username and ssh key 
* [deploy/operator.yaml](deploy/operator.yaml): modified to reference the firewall-inventory-secret, to reference the container image repository at quay.io and to have a pull policy of 'Always'
* [roles/firewallrule/meta/main.yml](roles/firewallrule/meta/main.yml): modified to include the pfsensible modules and make them avialable using their short name
* [roles/firewallrule/tasks/main.yml](roles/firewallrule/tasks/main.yml): modified to invoke the pfsensible module to create or remove the firewall rule (dependent on the variable "state")
* [playbook.yml](playbook.yml): modified to adapt the runtime inventory to include the firewall based on the access data provided in the secret, then invoke the firewallrule role against the firewall
* [watches.yaml](watches.yaml): modified with a finalizer statement to ensure that the playbook is run with the extra variable "state" set to "absent" when the custom resource is deleted

## Local Testing
The [Vagrant file](../Vagrantfile) in the main project is prepared to allow local testing of the operator via ```operator-sdk run --local```. 

If you are developing outside of Vagrant, you need to ensure that:
* The operator code is avialable at /opt/ansible (i.e. there is an /opt/ansible/playbook.yml, ...), e.g. by symlinking this directory there
* operator-sdk and ansible are installed
* the following python modules are installed: python3-ansible-runner, python3-kubernetes, python3-openshift
* the following ansible modules are avialable from ansible-galaxy: operator_sdk.util, pfsensible.core
* the inventory files hostname, ansible_user and privatekey are available in /tmp/inventory (see [deploy/firewall-inventory-secret-example.yaml](deploy/firewall-inventory-secret-example.yaml)) with permissions 600 for the privatekey file

## Building the Operator Container Image
To build the operator as container image follow the steps below:
1. Create a repository in your container registry, e.g. quay.io
2. Ensure that your environment has docker (or a comparable OCI container build tool) installed
3. Log into your container registry (e.g. via docker login)
4. Build the container image by executing ```sudo operator-sdk build your.registry/namespace/imagename:tag``` with your selection of registry/namespace/imagename/tag 
5. Push the container image to the registry by executing ```sudo docker push your.registry/namespace/imagename:tag```

## Deploying the operator to Kubernetes
To deploy the operator onto a kubernetes cluster follow the steps below (Note: a deployment via OLM is not yet implemented):

1. Ensure that your environment has kubectl or the oc command line installed
2. Create a namespace / project in your kubernetes cluster
3. Log into your kubernetes cluster + namespaces with kubectl / oc
4. Ensure the role, rolebinding, serviceaccount, FirewallRule CRD and sample FirewallRule CR are created by executing ```kubectl apply -k deploy```
5. Generate an SSH public/private key pair using ```ssh-keygen```
6. In your pfSense firewall instance, enable ssh and register the public key for the root user in /root/.ssh/authorized_keys
7. Copy & adjust the [sample firewall secret](deploy/firewall-inventory-secret-example.yaml) as ```firewall-inventory-secret.yaml```to include the ssh private key, the firewall access username (e.g. root) and the firewall's DNS name or IP address
8. Instantiate the secret using ```kubectl apply -f deploy/firewall-inventory-secret.yaml```
9. If necessary, update the operator image name/tag in the [deploy/operator.yaml](deploy/operator.yaml)
10. Create the operator deployment via ```kubectl apply -f deploy/operator.yaml```

## Undeploying the operator from Kubernetes

1. kubectl delete -f deploy/operator.yaml
1. kubectl delete -f deploy/firewall-inventory-secret.yaml
2. kubectl delete -k deploy

## Using the Operator to create Firewall Rules

Create a Firewall Rule in pfSense by creating a FirewallRule custom resource. An [example](deploy/crds/manuela.redhat.com_v1alpha1_firewallrule_cr.yaml) is given in the deploy directory and is automatically instantiated in the deployment instructions.

Delete the firewall rule by deleting the FirewallRule custom resource from the kubernetes cluster.
